<!DOCTYPE html><html lang="en" class="__variable_5cfdac __variable_7620cf"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/569ce4b8f30dc480-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/6975cac0a7ae24f4-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/logo.jpg"/><link rel="preload" as="image" href="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic01.png"/><link rel="preload" as="image" href="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic02.jpg"/><link rel="preload" as="image" href="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic03.jpg"/><link rel="preload" as="image" href="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic04.jpg"/><link rel="preload" as="image" href="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic05.jpg"/><link rel="stylesheet" href="/_next/static/css/641a7206b694a0e9.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/598b09e17ec3b27b.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-f01908b6ff80c1c4.js"/><script src="/_next/static/chunks/4bd1b696-67ee12fb04071d3b.js" async=""></script><script src="/_next/static/chunks/684-0fcfb85819efd5b6.js" async=""></script><script src="/_next/static/chunks/main-app-5e733401fc257057.js" async=""></script><script src="/_next/static/chunks/874-9a172bef94aec849.js" async=""></script><script src="/_next/static/chunks/63-1dff2157d01a3c16.js" async=""></script><script src="/_next/static/chunks/app/layout-1d891d5b0c81a46c.js" async=""></script><script src="/_next/static/chunks/app/page-f26b33fbd2941cff.js" async=""></script><meta name="next-size-adjust" content=""/><title>Andy Golubev | Cloud Architect &amp; DevOps Engineer</title><meta name="description" content="Personal website of AWS &amp; GCP certified Cloud Architect &amp; DevOps Engineer Andy Golubev. Certifications, GitHub work, and articles on Kubernetes and Terraform."/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="48x48"/><link rel="icon" href="/icon.png?a0799f5d3aa48e9f" type="image/png" sizes="512x512"/><link rel="apple-touch-icon" href="/apple-icon.png?21c489252a03a1cc" type="image/png" sizes="180x180"/><script>document.querySelectorAll('body link[rel="icon"], body link[rel="apple-touch-icon"]').forEach(el => document.head.appendChild(el))</script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><header class="Header_header__AF_3G"><div class="Header_rect__bQjpJ"></div><nav class="Header_nav__LVYU2"><a href="/">Home</a><a href="mailto:andygolubevcontact@gmail.com" target="_blank">Contact</a><a href="/articles/">Articles</a><a href="https://github.com/andygolubev" target="_blank">GitHub</a><a href="https://www.linkedin.com/in/andy-golubev/" target="_blank">LinkedIn</a></nav></header><div class="page_articleContainer__6YqF2"><h1 style="font-size:2rem">Kubernetes The Hard Way on AWS with Packer and Terraform</h1>
<p><strong>Date: 17 October 2023</strong></p>
<figure style="margin:2rem 0"><img src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/logo.jpg" alt="logo"/></figure>
<h2>Introduction</h2>
<p>Kubernetes has undoubtedly become the de facto standard for container orchestration, offering a powerful and flexible platform for deploying, managing, and scaling containerized applications. As organizations increasingly adopt cloud-native architectures, mastering Kubernetes has become a critical skill for both developers and operations teams. While there are numerous managed Kubernetes services available in the cloud, there&#x27;s immense value in understanding the intricacies of Kubernetes by building it from scratch, often referred to as &quot;the hard way.&quot;</p>
<p>I don&#x27;t consider myself a regular user of this type of Kubernetes cluster because it can be challenging to maintain. However, it does serve as a valuable tool for educational purposes.</p>
<p>I created this cluster with guidance from an ACloudGuru course called &quot;Kubernetes the hard way.&quot; It was quite a challenge because the course utilized an older version of Kubernetes and an outdated DNS plugin. As a result, I had to modify many scripts and troubleshoot extensively. However, despite the difficulties, it turned out to be an enjoyable experience. Additionally, I had to design a multi-Availability Zone (AZ) network for my EC2 instances and set up all the necessary network components. This was necessary because the original course had initially placed all the hosts in the same security group.</p>
<h2>Architecture</h2>
<p>My solution utilizes three Availability Zones (AZs) within the same region. Additionally, I employ a bastion host for communication with my cluster. All of the EC2 instances use custom images that I constructed during the previous stage of my pipeline.</p>
<figure style="margin:2rem 0"><img src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic01.png" alt="architecture diagram"/></figure>
<h2>Realization</h2>
<p>I start by creating a Terraform state bucket and a DynamoDB table using the AWS CLI. This is a fairly common block in my pipelines.</p>
<pre><code>...
env:
    # prefixes must be the same as in the 00-provider.tf
    AWS_BUCKET_NAME_PREFIX: &quot;terraform-state-for-kubernetes-the-hard-way-packer&quot; 
    AWS_DYNAMO_DB_TABLE_NAME_PREFIX: &quot;terraform-state-for-terraform-state-for-kubernetes-the-hard-way-packer&quot;

AWS_REGION: ${{ vars.AWS_REGION }}

...
    - name: Create a bucket
        run: |
        if [[ &quot;${{ env.AWS_REGION }}&quot; == &quot;us-east-1&quot; ]]; then
            aws s3api create-bucket --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --region $AWS_REGION --no-cli-pager
        else
            aws s3api create-bucket --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --region $AWS_REGION --no-cli-pager --create-bucket-configuration LocationConstraint=$AWS_REGION
        fi

        aws s3api put-bucket-versioning --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --versioning-configuration Status=Enabled
        aws s3api put-bucket-encryption --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --server-side-encryption-configuration &#x27;{&quot;Rules&quot;: [{&quot;ApplyServerSideEncryptionByDefault&quot;: {&quot;SSEAlgorithm&quot;: &quot;AES256&quot;}}]}&#x27;

    - name: Create a DynamoDB table
        run: |
        aws dynamodb create-table --table-name $AWS_DYNAMO_DB_TABLE_NAME_PREFIX-$AWS_REGION --attribute-definitions AttributeName=LockID,AttributeType=S --key-schema AttributeName=LockID,KeyType=HASH --billing-mode PAY_PER_REQUEST --tags Key=Name,Value=&quot;terraform state dynamo table&quot; Key=CreatedBy,Value=&quot;AWS CLI&quot; Key=Region,Value=$AWS_REGION 

    - name: Create a default VPC in the region
        run: |
        aws ec2 create-default-vpc || true    # create default VPC if not exist. It is required for AMI building 
</code></pre>
<p>Then I use bash scripts within the pipeline to create certificates and configurations.</p>
<pre><code>➜  scripts-for-certs-and-configs git:(main) tree 
.
├── 00-k8s-network.sh
├── 01-certs-ca.sh
├── 02-certs-components.sh
├── 03-certs-api-server.sh
├── 04-certs-service-account.sh
├── 05-kubeconfig.sh
├── 06-generate-encryption-config.sh
├── 07-generate-etcd-service.sh
├── 08-generate-control-plane-configs.sh
├── 09-generate-cluster-role.sh
├── 10-generate-ngix-config.sh
├── 11-generate-containerd-config.sh
├── 12-generate-kubelet-config.sh
├── 13-generate-kube-proxy-config.sh
├── 14-bastion-key.sh
├── 15-generate-wavenet-manifest.sh
└── 16-generate-coredns-manifest.sh
</code></pre>
<p>After that, I utilize Packer to build all the Amazon Machine Images (AMIs) and copy necessary files.</p>
<pre><code>==&gt; Builds finished. The artifacts of successful builds are:
--&gt; k8s-control-plane-2.amazon-ebs.ubuntu-kubernetes-the-hard-way-control-plane-2: AMIs were created:
us-west-2: ami-0314729fef4933bdc

--&gt; k8s-control-plane-0.amazon-ebs.ubuntu-kubernetes-the-hard-way-control-plane-0: AMIs were created:
us-west-2: ami-088c138db1acf379f

--&gt; k8s-control-plane-1.amazon-ebs.ubuntu-kubernetes-the-hard-way-control-plane-1: AMIs were created:
us-west-2: ami-0d348cd361f433388

--&gt; k8s-load-balancer-internal.amazon-ebs.ubuntu-kubernetes-the-hard-way-load-balancer-internal: AMIs were created:
us-west-2: ami-07cbdbe6027e64882

--&gt; k8s-bastion-host.amazon-ebs.ubuntu-kubernetes-the-hard-way-bastion-host: AMIs were created:
us-west-2: ami-0f0e571a26d6ac08a

--&gt; k8s-working-node-1.amazon-ebs.ubuntu-kubernetes-the-hard-way-working-node-1: AMIs were created:
us-west-2: ami-015f7e349eb6ec7ac

--&gt; k8s-working-node-2.amazon-ebs.ubuntu-kubernetes-the-hard-way-working-node-2: AMIs were created:
us-west-2: ami-03feac7b952f2ce5c

--&gt; k8s-working-node-0.amazon-ebs.ubuntu-kubernetes-the-hard-way-working-node-0: AMIs were created:
us-west-2: ami-089c713f758a50a63
</code></pre>
<p>Finally, I provision the entire infrastructure using my custom AMIs through Terraform.</p>
<pre><code>➜  terraform git:(main) tree
.
├── 00-provider.tf
├── 01-vpc.tf
├── 02-subnets.tf
├── 03-security-groups.tf
├── 04-route-tables.tf
├── 05-nat-gateway.tf
├── 06-ssh-key.tf
├── 07-ec2-control-plane.tf
├── 08-ec2-load-balancer.tf
├── 09-ec2-working-node.tf
├── 10-ec2-bastion.tf
└── 99-variables.tf
</code></pre>
<p>You can watch a time-lapsed video.</p>
<video width="100%" controls=""><source src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/video01.mp4" type="video/mp4"/><p>Your browser does not support the video tag.</p></video>
<h3>This is what we observe in the AWS console</h3>
<p>Here are the results as I see them in the AWS console:</p>
<p>VPC</p>
<figure style="margin:2rem 0"><img src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic02.jpg" alt="vpc"/></figure>
<p>AMIs</p>
<figure style="margin:2rem 0"><img src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic03.jpg" alt="amis"/></figure>
<p>Instances</p>
<figure style="margin:2rem 0"><img src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic04.jpg" alt="instances"/></figure>
<p>Kubernetes objects</p>
<figure style="margin:2rem 0"><img src="/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic05.jpg" alt="kubernetes objects"/></figure>
<h2>Conclusion</h2>
<p>To summarize, my journey of building Kubernetes on AWS using Terraform and Packer was very educational. Although it was not easy, it was a unique opportunity to learn Kubernetes architecture and how it works in depth.</p>
<p>I hope you enjoy this article.</p>
<p>You can find all of my code in my GitHub repository: <a href="https://github.com/andygolubev/kubernetes-the-hard-way-aws">https://github.com/andygolubev/kubernetes-the-hard-way-aws</a></p>
<p>Feel free to connect with me on LinkedIn: <a href="https://www.linkedin.com/in/andy-golubev/">https://www.linkedin.com/in/andy-golubev/</a></p></div><!--$--><!--/$--><!--$--><!--/$--><footer class="Footer_footer__4vzqH"><div class="Footer_footerContainer__77_mg"><h2>Run in the cloud. Reach the world.</h2><div class="Footer_footerLinks__xuRtG"><a href="https://github.com/andygolubev" target="_blank"><img alt="GitHub" loading="lazy" width="24" height="24" decoding="async" data-nimg="1" style="color:transparent" src="/images/icons/github.svg"/></a><a href="https://www.linkedin.com/in/andy-golubev/" target="_blank"><img alt="LinkedIn" loading="lazy" width="24" height="24" decoding="async" data-nimg="1" style="color:transparent" src="/images/icons/linkedin.svg"/></a><a href="mailto:andygolubevcontact@gmail.com" target="_blank"><img alt="Send email" loading="lazy" width="24" height="24" decoding="async" data-nimg="1" style="color:transparent" src="/images/icons/email.svg"/></a></div></div></footer><script src="/_next/static/chunks/webpack-f01908b6ff80c1c4.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[2784,[\"874\",\"static/chunks/874-9a172bef94aec849.js\",\"63\",\"static/chunks/63-1dff2157d01a3c16.js\",\"177\",\"static/chunks/app/layout-1d891d5b0c81a46c.js\"],\"default\"]\n3:I[7555,[],\"\"]\n4:I[1295,[],\"\"]\n5:I[3063,[\"874\",\"static/chunks/874-9a172bef94aec849.js\",\"63\",\"static/chunks/63-1dff2157d01a3c16.js\",\"974\",\"static/chunks/app/page-f26b33fbd2941cff.js\"],\"Image\"]\n7:I[9665,[],\"MetadataBoundary\"]\n9:I[9665,[],\"OutletBoundary\"]\nc:I[4911,[],\"AsyncMetadataOutlet\"]\ne:I[9665,[],\"ViewportBoundary\"]\n10:I[6614,[],\"\"]\n:HL[\"/_next/static/media/569ce4b8f30dc480-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/media/6975cac0a7ae24f4-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/641a7206b694a0e9.css\",\"style\"]\n:HL[\"/_next/static/css/598b09e17ec3b27b.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"8ZLUY0SqD1m6Xrr0p_g4G\",\"p\":\"\",\"c\":[\"\",\"articles\",\"kubernetes-the-hard-way-on-aws-with-packer-and-terraform\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"articles\",{\"children\":[[\"slug\",\"kubernetes-the-hard-way-on-aws-with-packer-and-terraform\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/641a7206b694a0e9.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__variable_5cfdac __variable_7620cf\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"$L2\",null,{}],[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}],[\"$\",\"footer\",null,{\"className\":\"Footer_footer__4vzqH\",\"children\":[\"$\",\"div\",null,{\"className\":\"Footer_footerContainer__77_mg\",\"children\":[[\"$\",\"h2\",null,{\"children\":\"Run in the cloud. Reach the world.\"}],[\"$\",\"div\",null,{\"className\":\"Footer_footerLinks__xuRtG\",\"children\":[[\"$\",\"a\",null,{\"href\":\"https://github.com/andygolubev\",\"target\":\"_blank\",\"children\":[\"$\",\"$L5\",null,{\"src\":\"/images/icons/github.svg\",\"alt\":\"GitHub\",\"width\":24,\"height\":24}]}],[\"$\",\"a\",null,{\"href\":\"https://www.linkedin.com/in/andy-golubev/\",\"target\":\"_blank\",\"children\":[\"$\",\"$L5\",null,{\"src\":\"/images/icons/linkedin.svg\",\"alt\":\"LinkedIn\",\"width\":24,\"height\":24}]}],[\"$\",\"a\",null,{\"href\":\"mailto:andygolubevcontact@gmail.com\",\"target\":\"_blank\",\"children\":[\"$\",\"$L5\",null,{\"src\":\"/images/icons/email.svg\",\"alt\":\"Send email\",\"width\":24,\"height\":24}]}]]}]]}]}]]}]}]]}],{\"children\":[\"articles\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"slug\",\"kubernetes-the-hard-way-on-aws-with-packer-and-terraform\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L6\",[\"$\",\"$L7\",null,{\"children\":\"$L8\"}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/598b09e17ec3b27b.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L9\",null,{\"children\":[\"$La\",\"$Lb\",[\"$\",\"$Lc\",null,{\"promise\":\"$@d\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"-Q7PMYDgr90oF0gmscnuD\",{\"children\":[[\"$\",\"$Le\",null,{\"children\":\"$Lf\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],null]}],false]],\"m\":\"$undefined\",\"G\":[\"$10\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"11:\"$Sreact.suspense\"\n12:I[4911,[],\"AsyncMetadata\"]\n8:[\"$\",\"$11\",null,{\"fallback\":null,\"children\":[\"$\",\"$L12\",null,{\"promise\":\"$@13\"}]}]\n"])</script><script>self.__next_f.push([1,"b:null\n"])</script><script>self.__next_f.push([1,"14:T65e,...\nenv:\n    # prefixes must be the same as in the 00-provider.tf\n    AWS_BUCKET_NAME_PREFIX: \"terraform-state-for-kubernetes-the-hard-way-packer\" \n    AWS_DYNAMO_DB_TABLE_NAME_PREFIX: \"terraform-state-for-terraform-state-for-kubernetes-the-hard-way-packer\"\n\nAWS_REGION: ${{ vars.AWS_REGION }}\n\n...\n    - name: Create a bucket\n        run: |\n        if [[ \"${{ env.AWS_REGION }}\" == \"us-east-1\" ]]; then\n            aws s3api create-bucket --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --region $AWS_REGION --no-cli-pager\n        else\n            aws s3api create-bucket --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --region $AWS_REGION --no-cli-pager --create-bucket-configuration LocationConstraint=$AWS_REGION\n        fi\n\n        aws s3api put-bucket-versioning --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --versioning-configuration Status=Enabled\n        aws s3api put-bucket-encryption --bucket $AWS_BUCKET_NAME_PREFIX-$AWS_REGION --server-side-encryption-configuration '{\"Rules\": [{\"ApplyServerSideEncryptionByDefault\": {\"SSEAlgorithm\": \"AES256\"}}]}'\n\n    - name: Create a DynamoDB table\n        run: |\n        aws dynamodb create-table --table-name $AWS_DYNAMO_DB_TABLE_NAME_PREFIX-$AWS_REGION --attribute-definitions AttributeName=LockID,AttributeType=S --key-schema AttributeName=LockID,KeyType=HASH --billing-mode PAY_PER_REQUEST --tags Key=Name,Value=\"terraform state dynamo table\" Key=CreatedBy,Value=\"AWS CLI\" Key=Region,Value=$AWS_REGION \n\n    - name: Create a default VPC in the region\n        run: |\n        aws ec2 create-default-vpc || true    # create default VPC if not exist. It is required for AMI building \n15:T47e,==\u003e Builds finished. The artifacts of successful builds are:\n--\u003e k8s-control-plane-2.amazon-ebs.ubuntu-kubernetes-the-hard-way-control-plane-2: AMIs were created:\nus-west-2: ami-0314729fef4933bdc\n\n--\u003e k8s-control-plane-0.amazon-ebs.ubuntu-kubernetes-the-hard-way-control-plane-0: AMIs were created:\nus-west-2: ami-088c138db1acf379f\n\n--\u003e k8s-control-plane-1.amazon-ebs.ubuntu-kubernetes-the-hard-way-con"])</script><script>self.__next_f.push([1,"trol-plane-1: AMIs were created:\nus-west-2: ami-0d348cd361f433388\n\n--\u003e k8s-load-balancer-internal.amazon-ebs.ubuntu-kubernetes-the-hard-way-load-balancer-internal: AMIs were created:\nus-west-2: ami-07cbdbe6027e64882\n\n--\u003e k8s-bastion-host.amazon-ebs.ubuntu-kubernetes-the-hard-way-bastion-host: AMIs were created:\nus-west-2: ami-0f0e571a26d6ac08a\n\n--\u003e k8s-working-node-1.amazon-ebs.ubuntu-kubernetes-the-hard-way-working-node-1: AMIs were created:\nus-west-2: ami-015f7e349eb6ec7ac\n\n--\u003e k8s-working-node-2.amazon-ebs.ubuntu-kubernetes-the-hard-way-working-node-2: AMIs were created:\nus-west-2: ami-03feac7b952f2ce5c\n\n--\u003e k8s-working-node-0.amazon-ebs.ubuntu-kubernetes-the-hard-way-working-node-0: AMIs were created:\nus-west-2: ami-089c713f758a50a63\n"])</script><script>self.__next_f.push([1,"6:[\"$\",\"div\",null,{\"className\":\"page_articleContainer__6YqF2\",\"children\":[[\"$\",\"h1\",null,{\"style\":{\"fontSize\":\"2rem\"},\"children\":\"Kubernetes The Hard Way on AWS with Packer and Terraform\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"Date: 17 October 2023\"}]}],\"\\n\",[\"$\",\"figure\",null,{\"style\":{\"margin\":\"2rem 0\"},\"children\":[\"$\",\"img\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/logo.jpg\",\"alt\":\"logo\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Introduction\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Kubernetes has undoubtedly become the de facto standard for container orchestration, offering a powerful and flexible platform for deploying, managing, and scaling containerized applications. As organizations increasingly adopt cloud-native architectures, mastering Kubernetes has become a critical skill for both developers and operations teams. While there are numerous managed Kubernetes services available in the cloud, there's immense value in understanding the intricacies of Kubernetes by building it from scratch, often referred to as \\\"the hard way.\\\"\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I don't consider myself a regular user of this type of Kubernetes cluster because it can be challenging to maintain. However, it does serve as a valuable tool for educational purposes.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I created this cluster with guidance from an ACloudGuru course called \\\"Kubernetes the hard way.\\\" It was quite a challenge because the course utilized an older version of Kubernetes and an outdated DNS plugin. As a result, I had to modify many scripts and troubleshoot extensively. However, despite the difficulties, it turned out to be an enjoyable experience. Additionally, I had to design a multi-Availability Zone (AZ) network for my EC2 instances and set up all the necessary network components. This was necessary because the original course had initially placed all the hosts in the same security group.\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Architecture\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"My solution utilizes three Availability Zones (AZs) within the same region. Additionally, I employ a bastion host for communication with my cluster. All of the EC2 instances use custom images that I constructed during the previous stage of my pipeline.\"}],\"\\n\",[\"$\",\"figure\",null,{\"style\":{\"margin\":\"2rem 0\"},\"children\":[\"$\",\"img\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic01.png\",\"alt\":\"architecture diagram\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Realization\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I start by creating a Terraform state bucket and a DynamoDB table using the AWS CLI. This is a fairly common block in my pipelines.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"$14\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Then I use bash scripts within the pipeline to create certificates and configurations.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"➜  scripts-for-certs-and-configs git:(main) tree \\n.\\n├── 00-k8s-network.sh\\n├── 01-certs-ca.sh\\n├── 02-certs-components.sh\\n├── 03-certs-api-server.sh\\n├── 04-certs-service-account.sh\\n├── 05-kubeconfig.sh\\n├── 06-generate-encryption-config.sh\\n├── 07-generate-etcd-service.sh\\n├── 08-generate-control-plane-configs.sh\\n├── 09-generate-cluster-role.sh\\n├── 10-generate-ngix-config.sh\\n├── 11-generate-containerd-config.sh\\n├── 12-generate-kubelet-config.sh\\n├── 13-generate-kube-proxy-config.sh\\n├── 14-bastion-key.sh\\n├── 15-generate-wavenet-manifest.sh\\n└── 16-generate-coredns-manifest.sh\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"After that, I utilize Packer to build all the Amazon Machine Images (AMIs) and copy necessary files.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"$15\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Finally, I provision the entire infrastructure using my custom AMIs through Terraform.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"➜  terraform git:(main) tree\\n.\\n├── 00-provider.tf\\n├── 01-vpc.tf\\n├── 02-subnets.tf\\n├── 03-security-groups.tf\\n├── 04-route-tables.tf\\n├── 05-nat-gateway.tf\\n├── 06-ssh-key.tf\\n├── 07-ec2-control-plane.tf\\n├── 08-ec2-load-balancer.tf\\n├── 09-ec2-working-node.tf\\n├── 10-ec2-bastion.tf\\n└── 99-variables.tf\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"You can watch a time-lapsed video.\"}],\"\\n\",[\"$\",\"video\",null,{\"width\":\"100%\",\"controls\":true,\"children\":[[\"$\",\"source\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/video01.mp4\",\"type\":\"video/mp4\"}],[\"$\",\"p\",null,{\"children\":\"Your browser does not support the video tag.\"}]]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"This is what we observe in the AWS console\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Here are the results as I see them in the AWS console:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"VPC\"}],\"\\n\",[\"$\",\"figure\",null,{\"style\":{\"margin\":\"2rem 0\"},\"children\":[\"$\",\"img\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic02.jpg\",\"alt\":\"vpc\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"AMIs\"}],\"\\n\",[\"$\",\"figure\",null,{\"style\":{\"margin\":\"2rem 0\"},\"children\":[\"$\",\"img\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic03.jpg\",\"alt\":\"amis\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Instances\"}],\"\\n\",[\"$\",\"figure\",null,{\"style\":{\"margin\":\"2rem 0\"},\"children\":[\"$\",\"img\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic04.jpg\",\"alt\":\"instances\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Kubernetes objects\"}],\"\\n\",[\"$\",\"figure\",null,{\"style\":{\"margin\":\"2rem 0\"},\"children\":[\"$\",\"img\",null,{\"src\":\"/articles/kubernetes-the-hard-way-on-aws-with-packer-and-terraform/pic05.jpg\",\"alt\":\"kubernetes objects\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Conclusion\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"To summarize, my journey of building Kubernetes on AWS using Terraform and Packer was very educational. Although it was not easy, it was a unique opportunity to learn Kubernetes architecture and how it works in depth.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I hope you enjoy this article.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"You can find all of my code in my GitHub repository: \",[\"$\",\"a\",null,{\"href\":\"https://github.com/andygolubev/kubernetes-the-hard-way-aws\",\"children\":\"https://github.com/andygolubev/kubernetes-the-hard-way-aws\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Feel free to connect with me on LinkedIn: \",[\"$\",\"a\",null,{\"href\":\"https://www.linkedin.com/in/andy-golubev/\",\"children\":\"https://www.linkedin.com/in/andy-golubev/\"}]]}]]}]\n"])</script><script>self.__next_f.push([1,"f:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\na:null\n"])</script><script>self.__next_f.push([1,"13:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"Andy Golubev | Cloud Architect \u0026 DevOps Engineer\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Personal website of AWS \u0026 GCP certified Cloud Architect \u0026 DevOps Engineer Andy Golubev. Certifications, GitHub work, and articles on Kubernetes and Terraform.\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"48x48\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/icon.png?a0799f5d3aa48e9f\",\"type\":\"image/png\",\"sizes\":\"512x512\"}],[\"$\",\"link\",\"4\",{\"rel\":\"apple-touch-icon\",\"href\":\"/apple-icon.png?21c489252a03a1cc\",\"type\":\"image/png\",\"sizes\":\"180x180\"}]],\"error\":null,\"digest\":\"$undefined\"}\nd:{\"metadata\":\"$13:metadata\",\"error\":null,\"digest\":\"$undefined\"}\n"])</script></body></html>