1:"$Sreact.fragment"
2:I[2784,["874","static/chunks/874-1d5071fab5c23a5a.js","63","static/chunks/63-b8ef6e972851fb15.js","177","static/chunks/app/layout-128ffe95b5a5832b.js"],"default"]
3:I[7555,[],""]
4:I[1295,[],""]
5:I[4557,["874","static/chunks/874-1d5071fab5c23a5a.js","63","static/chunks/63-b8ef6e972851fb15.js","598","static/chunks/598-889c1586942b7842.js","974","static/chunks/app/page-c42db5e253cc6e8c.js"],"default"]
6:I[3063,["874","static/chunks/874-1d5071fab5c23a5a.js","63","static/chunks/63-b8ef6e972851fb15.js","598","static/chunks/598-889c1586942b7842.js","974","static/chunks/app/page-c42db5e253cc6e8c.js"],"Image"]
8:I[9665,[],"MetadataBoundary"]
a:I[9665,[],"OutletBoundary"]
d:I[4911,[],"AsyncMetadataOutlet"]
f:I[9665,[],"ViewportBoundary"]
11:I[6614,[],""]
:HL["/_next/static/media/569ce4b8f30dc480-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/media/6975cac0a7ae24f4-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/_next/static/css/8f74a3e5566f948c.css","style"]
:HL["/_next/static/css/7599afaaf9c9e399.css","style"]
:HL["/_next/static/css/598b09e17ec3b27b.css","style"]
0:{"P":null,"b":"O8H6bF7pcj2mznJgXipHh","p":"","c":["","articles","monitoring-multiple-k8s-clusters-with-prometheus-and-grafana-deployed-using-terraform-and-ansible-role",""],"i":false,"f":[[["",{"children":["articles",{"children":[["slug","monitoring-multiple-k8s-clusters-with-prometheus-and-grafana-deployed-using-terraform-and-ansible-role","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/8f74a3e5566f948c.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/7599afaaf9c9e399.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"__variable_5cfdac __variable_7620cf","children":["$","body",null,{"children":[["$","$L2",null,{}],["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}],["$","footer",null,{"className":"Footer_footer__4vzqH","children":["$","div",null,{"className":"Footer_footerContainer__77_mg","children":[["$","$L5",null,{"src":"/images/sky/hero.jpg","alt":"Footer background","className":"Footer_footerBackgroundImage__aXnu1"}],["$","h2",null,{"children":"Run in the cloud. Reach the world."}],["$","div",null,{"className":"Footer_footerLinks__xuRtG","children":[["$","a",null,{"href":"https://github.com/andygolubev","target":"_blank","children":["$","$L6",null,{"src":"/images/icons/github.svg","alt":"GitHub","width":24,"height":24}]}],["$","a",null,{"href":"https://www.linkedin.com/in/andy-golubev/","target":"_blank","children":["$","$L6",null,{"src":"/images/icons/linkedin.svg","alt":"LinkedIn","width":24,"height":24}]}],["$","a",null,{"href":"mailto:andygolubevcontact@gmail.com","target":"_blank","children":["$","$L6",null,{"src":"/images/icons/email.svg","alt":"Send email","width":24,"height":24}]}]]}]]}]}],["$","div",null,{"className":"Credits_credits__Spqox","children":["$","a",null,{"href":"https://www.linkedin.com/in/olgagolubev/","target":"_blank","children":"Developed and designed by Olga Golubev"}]}]]}]}]]}],{"children":["articles",["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["slug","monitoring-multiple-k8s-clusters-with-prometheus-and-grafana-deployed-using-terraform-and-ansible-role","d"],["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L7",["$","$L8",null,{"children":"$L9"}],[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/598b09e17ec3b27b.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$La",null,{"children":["$Lb","$Lc",["$","$Ld",null,{"promise":"$@e"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","u6bJwnES-G-cpg6mMEudO",{"children":[["$","$Lf",null,{"children":"$L10"}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}],null]}],false]],"m":"$undefined","G":["$11","$undefined"],"s":false,"S":true}
12:"$Sreact.suspense"
13:I[4911,[],"AsyncMetadata"]
9:["$","$12",null,{"fallback":null,"children":["$","$L13",null,{"promise":"$@14"}]}]
c:null
7:["$","div",null,{"className":"page_articleContainer__6YqF2","children":[["$","h1",null,{"style":{"fontSize":"2rem"},"children":"Monitoring multiple k8s clusters on Digital Ocean with Prometheus and Grafana deployed using Terraform and Ansible role"}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Date: 27 August 2024"}]}],"\n",["$","figure",null,{"style":{"margin":"2rem 0"},"children":["$","img",null,{"src":"/articles/monitoring-multiple-k8s-clusters-with-prometheus-and-grafana-deployed-using-terraform-and-ansible-role/logo.jpg","alt":"logo"}]}],"\n",["$","h2",null,{"children":"Introduction"}],"\n",["$","p",null,{"children":"The internet is full of ready-made solutions for every taste, but problems arise when they don't fit your needs. That's when it's time to come up with something custom."}],"\n",["$","p",null,{"children":"This time, the challenge was to collect metrics from two K8S clusters located in different VPCs."}],"\n",["$","p",null,{"children":"It seemed like a simple task:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"Set up a dedicated server for Prometheus."}],"\n",["$","li",null,{"children":"Create a VPC Peering connection."}],"\n",["$","li",null,{"children":"Deploy Prometheus in each cluster."}],"\n",["$","li",null,{"children":"Set up federation."}],"\n"]}],"\n",["$","p",null,{"children":["However, the issue is that Digital Ocean Cloud doesn't support VPC Peering as of this writing (link to ",["$","a",null,{"href":"https://docs.digitalocean.com/reference/terraform/reference/resources/vpc_peering/","children":"documentation"}],"), meaning all metrics would leave the cloud, go to the internet, and then come back, causing unnecessary traffic costs."]}],"\n",["$","p",null,{"children":"To avoid this, we had to come up with alternative solutions that would work for a small startup while avoiding extra expenses."}],"\n",["$","h2",null,{"children":"Solution"}],"\n",["$","p",null,{"children":"So, here's the solution I implemented."}],"\n",["$","p",null,{"children":"There are three VPCs. Two of them host the clusters, and the third one contains the supporting tools, including a server with Grafana."}],"\n",["$","p",null,{"children":"Grafana connects to each cluster and pulls data for the dashboard. This setup ensures that traffic only flows when the dashboard is being viewed. Authentication is handled at the ingress."}],"\n",["$","figure",null,{"style":{"margin":"2rem 0"},"children":["$","img",null,{"src":"/articles/monitoring-multiple-k8s-clusters-with-prometheus-and-grafana-deployed-using-terraform-and-ansible-role/pic01-solution.jpg","alt":"solution"}]}],"\n",["$","h2",null,{"children":"Tools"}],"\n",["$","p",null,{"children":"For the implementation, I chose the following tools:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"Prometheus"}],"\n",["$","li",null,{"children":"Grafana"}],"\n",["$","li",null,{"children":"Loki"}],"\n",["$","li",null,{"children":"Terraform"}],"\n",["$","li",null,{"children":"Ansible role"}],"\n",["$","li",null,{"children":"Nginx"}],"\n",["$","li",null,{"children":"Docker Compose"}],"\n",["$","li",null,{"children":"Ubuntu server on Droplet"}],"\n"]}],"\n",["$","p",null,{"children":"I use Terraform to provision the server for the subsequent Grafana installation, as well as to create DNS records."}],"\n",["$","p",null,{"children":"I use an Ansible role to configure the server, including the installation and launch of all necessary services:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"Certbot"}],"\n",["$","li",null,{"children":"Docker"}],"\n",["$","li",null,{"children":"Nginx"}],"\n",["$","li",null,{"children":"Grafana dashboards"}],"\n"]}],"\n",["$","p",null,{"children":"Prometheus and Grafana Loki are installed in the K8S clusters, from where the metrics and logs are collected."}],"\n",["$","h2",null,{"children":"The Code"}],"\n",["$","p",null,{"children":"I have a standard Ansible role written with tasks and templates to automate the setup and configuration."}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"➜  monitoring-prometheus git:(main) tree monitoring_role \nmonitoring_role\n├── README.md\n├── defaults\n│   └── main.yml\n├── files\n│   ├── grafana-k8s-cluster-dashboard.json\n│   ├── grafana-k8s-logs-dashboard.json\n│   └── grafana-k8s-volumes-dashboard.json\n├── handlers\n│   └── main.yml\n├── meta\n│   └── main.yml\n├── tasks\n│   ├── 01_wait_for_initialization.yml\n│   ├── 02_install_certbot_and_configure_nginx.yml\n│   ├── 03_install_docker.yml\n│   ├── 04_add_monitoring_user.yml\n│   ├── 05_copy_configuration_files.yml\n│   ├── 06_run_containers.yml\n│   ├── 07_enable_ufw.yml\n│   └── main.yml\n├── templates\n│   ├── dashboards.yaml.j2\n│   ├── datasources.yaml.j2\n│   ├── default.j2\n│   └── docker-compose.yml.j2\n├── tests\n│   ├── inventory\n│   └── test.yml\n└── vars\n    └── main.yml\n"}]}],"\n",["$","p",null,{"children":"The Ansible role handles the issuance of certificates, installs Nginx, sets up Grafana with dashboards, and starts Docker compose."}],"\n",["$","h2",null,{"children":"Result"}],"\n",["$","p",null,{"children":"Here is an example of how the final dashboard looks:"}],"\n",["$","figure",null,{"style":{"margin":"2rem 0"},"children":["$","img",null,{"src":"/articles/monitoring-multiple-k8s-clusters-with-prometheus-and-grafana-deployed-using-terraform-and-ansible-role/pic02-grafana.jpg","alt":"dashboard"}]}],"\n",["$","h2",null,{"children":"Conclusion"}],"\n",["$","p",null,{"children":"You don't always need to rely on out-of-the-box solutions, especially when they don't fit your needs. With a bit of creativity and the right open-source tools, you can build a custom solution that's both effective and cost-efficient. In this case, combining Prometheus, Grafana, Loki, and a few other tools, I managed to set up a reliable monitoring system that works perfectly for a small startup without breaking the bank."}],"\n",["$","p",null,{"children":"I hope you enjoyed this article."}],"\n",["$","p",null,{"children":["You can find all of my code in my GitHub repository: ",["$","a",null,{"href":"https://github.com/andygolubev/monitoring-prometheus","children":"https://github.com/andygolubev/monitoring-prometheus"}]]}],"\n",["$","p",null,{"children":["Feel free to connect with me on LinkedIn: ",["$","a",null,{"href":"https://www.linkedin.com/in/andy-golubev/","children":"https://www.linkedin.com/in/andy-golubev/"}]]}]]}]
10:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
b:null
14:{"metadata":[["$","title","0",{"children":"Andy Golubev | Cloud Architect & DevOps Engineer"}],["$","meta","1",{"name":"description","content":"Personal website of AWS & GCP certified Cloud Architect & DevOps Engineer Andy Golubev. Certifications, GitHub work, and articles on Kubernetes and Terraform."}],["$","link","2",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"48x48"}],["$","link","3",{"rel":"icon","href":"/icon.png?a0799f5d3aa48e9f","type":"image/png","sizes":"512x512"}],["$","link","4",{"rel":"apple-touch-icon","href":"/apple-icon.png?21c489252a03a1cc","type":"image/png","sizes":"180x180"}]],"error":null,"digest":"$undefined"}
e:{"metadata":"$14:metadata","error":null,"digest":"$undefined"}
